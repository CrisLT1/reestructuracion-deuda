<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reestructuraci√≥n de Deuda</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0070c9 0%, #005a9e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #0070c9;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(0, 112, 201, 0.1);
        }

        .tab.active {
            background: white;
            color: #0070c9;
            border-bottom: 3px solid #0070c9;
            margin-bottom: -3px;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #0070c9;
        }

        .card h3 {
            color: #0070c9;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0070c9;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0070c9 0%, #005a9e 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 112, 201, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(82, 196, 26, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4d4f 0%, #cf1322 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #0070c9;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #0070c9;
            margin: 10px 0;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
        }

        .metric-comparison {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .metric-before, .metric-after {
            text-align: center;
        }

        .metric-arrow {
            font-size: 2em;
            color: #52c41a;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        thead {
            background: #0070c9;
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        tbody tr:hover {
            background: #e6f7ff;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-success {
            background: #d4f4dd;
            color: #389e0d;
        }

        .status-warning {
            background: #fff7e6;
            color: #d46b08;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-box {
            background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #1890ff;
        }

        .info-box h4 {
            color: #0050b3;
            margin-bottom: 10px;
        }

        .scenario-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .scenario-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-top: 5px solid #0070c9;
        }

        .scenario-card.best {
            border-top-color: #52c41a;
            background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%);
        }

        .scenario-card h4 {
            color: #0070c9;
            margin-bottom: 15px;
        }

        .scenario-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .alert-info {
            background: #e6f7ff;
            border-left: 5px solid #1890ff;
            color: #0050b3;
        }

        .alert-success {
            background: #f6ffed;
            border-left: 5px solid #52c41a;
            color: #389e0d;
        }

        .project-info {
            background: linear-gradient(135deg, #fff1f0 0%, #ffccc7 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .project-info h3 {
            color: #cf1322;
            margin-bottom: 15px;
        }

        .project-detail {
            display: flex;
            margin: 10px 0;
        }

        .project-detail strong {
            width: 150px;
            color: #8c8c8c;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        @media print {
            .tabs, .btn { display: none; }
            .container { box-shadow: none; }
        }

        .payment-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        #reportContent {
            background: white;
            padding: 40px;
            max-width: 900px;
            margin: 20px auto;
        }

        .report-header {
            text-align: center;
            border-bottom: 3px solid #0070c9;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .report-section {
            margin: 30px 0;
        }

        .report-section h3 {
            color: #0070c9;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Sistema de Reestructuraci√≥n de Deuda</h1>
            <p>Gesti√≥n integral de deuda y optimizaci√≥n financiera</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSection('dashboard')">üè† Dashboard</button>
            <button class="tab" onclick="showSection('datos')">üìù Datos Base</button>
            <button class="tab" onclick="showSection('metricas')">üìà M√©tricas</button>
            <button class="tab" onclick="showSection('escenarios')">üîÑ Escenarios</button>
            <button class="tab" onclick="showSection('pagos')">üí∞ Pagos</button>
            <button class="tab" onclick="showSection('reporte')">üìÑ Reporte</button>
        </div>

        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="section active">
                <div class="project-info">
                    <h3>üìã Informaci√≥n del Proyecto</h3>
                    <div class="project-detail">
                        <strong>Problema:</strong>
                        <span>Estructura de deuda y gasto financiero elevada que restringe la inversi√≥n operativa y el crecimiento.</span>
                    </div>
                    <div class="project-detail">
                        <strong>Propuesta:</strong>
                        <span>Reestructurar deuda y optimizar gastos mediante renegociaci√≥n de plazos/tasas.</span>
                    </div>
                    <div class="project-detail">
                        <strong>Objetivo:</strong>
                        <span>Disminuir servicio de la deuda y mejorar flujo de caja.</span>
                    </div>
                    <div class="project-detail">
                        <strong>Plazo:</strong>
                        <span>01-06-2026 a 14-12-2026 (Largo Plazo)</span>
                    </div>
                    <div class="project-detail">
                        <strong>Resultado Esperado:</strong>
                        <span>Mayor solvencia y margen operativo.</span>
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Acciones R√°pidas</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showSection('datos')">üìù Ingresar Datos</button>
                        <button class="btn btn-success" onclick="calcularMetricas()">üìä Calcular M√©tricas</button>
                        <button class="btn btn-info" onclick="compararEscenarios()">üîÑ Comparar Escenarios</button>
                        <button class="btn btn-primary" onclick="generarReporte()">üìÑ Generar Reporte</button>
                        <button class="btn btn-success" onclick="exportarPDF()">‚¨áÔ∏è Exportar PDF</button>
                    </div>
                </div>

                <div id="dashboardMetrics"></div>
            </div>

            <!-- DATOS BASE -->
            <div id="datos" class="section">
                <div class="card">
                    <h3>üí∞ Datos Financieros Actuales</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Deuda Total Actual ($)</label>
                            <input type="number" id="deudaTotal" placeholder="Ej: 1000000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tasa de Inter√©s Anual (%)</label>
                            <input type="number" id="tasaInteres" placeholder="Ej: 12.5" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Plazo Actual (meses)</label>
                            <input type="number" id="plazoActual" placeholder="Ej: 36">
                        </div>
                        <div class="form-group">
                            <label>Ingresos Mensuales ($)</label>
                            <input type="number" id="ingresosMensuales" placeholder="Ej: 150000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Ventas Anuales ($)</label>
                            <input type="number" id="ventasAnuales" placeholder="Ej: 2000000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Gastos Financieros Mensuales ($)</label>
                            <input type="number" id="gastosFinancieros" placeholder="Ej: 12000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Utilidad Operacional Mensual ($)</label>
                            <input type="number" id="utilidadOperacional" placeholder="Ej: 30000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>D√≠as de Pago Promedio</label>
                            <input type="number" id="diasPago" placeholder="Ej: 45">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üîÑ Escenario de Reestructuraci√≥n</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nueva Tasa de Inter√©s (%)</label>
                            <input type="number" id="nuevaTasa" placeholder="Ej: 8.5" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Nuevo Plazo (meses)</label>
                            <input type="number" id="nuevoPlazo" placeholder="Ej: 48">
                        </div>
                        <div class="form-group">
                            <label>Quita de Capital (%)</label>
                            <input type="number" id="quitaCapital" placeholder="Ej: 15" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Reducci√≥n Gastos No Cr√≠ticos ($)</label>
                            <input type="number" id="reduccionGastos" placeholder="Ej: 5000" step="0.01">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="guardarDatos()">üíæ Guardar Datos</button>
                        <button class="btn btn-primary" onclick="validarDatos()">‚úì Validar Datos</button>
                    </div>
                </div>
            </div>

            <!-- M√âTRICAS -->
            <div id="metricas" class="section">
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Las m√©tricas se calculan autom√°ticamente basadas en los datos ingresados. Los valores proyectados consideran la reestructuraci√≥n propuesta.
                </div>

                <div id="metricasContent"></div>
            </div>

            <!-- ESCENARIOS -->
            <div id="escenarios" class="section">
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Comparaci√≥n de diferentes estrategias de reestructuraci√≥n. El escenario recomendado aparecer√° resaltado en verde.
                </div>

                <div id="escenariosContent"></div>
            </div>

            <!-- PAGOS -->
            <div id="pagos" class="section">
                <div class="card">
                    <h3>‚ûï Registrar Nuevo Pago</h3>
                    <div class="payment-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="fechaPago">
                            </div>
                            <div class="form-group">
                                <label>Concepto</label>
                                <input type="text" id="conceptoPago" placeholder="Ej: Pago cuota mensual">
                            </div>
                            <div class="form-group">
                                <label>Monto Pagado ($)</label>
                                <input type="number" id="montoPago" placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Observaciones</label>
                                <input type="text" id="observacionesPago" placeholder="Opcional">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="registrarPago()">üí∞ Registrar Pago</button>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã Historial de Pagos</h3>
                    <div class="table-container">
                        <table id="tablaPagos">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Monto Pagado</th>
                                    <th>Saldo Pendiente</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="bodyPagos">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">No hay pagos registrados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REPORTE -->
            <div id="reporte" class="section">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generarReporte()">üìÑ Generar/Actualizar Reporte</button>
                    <button class="btn btn-success" onclick="exportarPDF()">‚¨áÔ∏è Descargar PDF</button>
                    <button class="btn btn-info" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                </div>

                <div id="reportContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Variables globales para almacenar datos
        let datosFinancieros = {};
        let pagosRegistrados = [];

        // Inicializar fecha actual
        document.getElementById('fechaPago').valueAsDate = new Date();

        // Funci√≥n para cambiar de secci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // Guardar datos
        function guardarDatos() {
            datosFinancieros = {
                deudaTotal: parseFloat(document.getElementById('deudaTotal').value) || 0,
                tasaInteres: parseFloat(document.getElementById('tasaInteres').value) || 0,
                plazoActual: parseInt(document.getElementById('plazoActual').value) || 0,
                ingresosMensuales: parseFloat(document.getElementById('ingresosMensuales').value) || 0,
                ventasAnuales: parseFloat(document.getElementById('ventasAnuales').value) || 0,
                utilidadOperacional: parseFloat(document.getElementById('utilidadOperacional').value) || 0,
                gastosFinancieros: parseFloat(document.getElementById('gastosFinancieros').value) || 0,
                diasPago: parseInt(document.getElementById('diasPago').value) || 0,
                nuevaTasa: parseFloat(document.getElementById('nuevaTasa').value) || 0,
                nuevoPlazo: parseInt(document.getElementById('nuevoPlazo').value) || 0,
                quitaCapital: parseFloat(document.getElementById('quitaCapital').value) || 0,
                reduccionGastos: parseFloat(document.getElementById('reduccionGastos').value) || 0
            };
            
            alert('‚úÖ Datos guardados correctamente');
            actualizarDashboard();
        }

        // Validar datos
        function validarDatos() {
            const errores = [];
            
            if (!datosFinancieros.deudaTotal || datosFinancieros.deudaTotal <= 0) 
                errores.push('- Deuda Total debe ser mayor a 0');
            if (!datosFinancieros.tasaInteres || datosFinancieros.tasaInteres <= 0) 
                errores.push('- Tasa de Inter√©s debe ser mayor a 0');
            if (!datosFinancieros.plazoActual || datosFinancieros.plazoActual <= 0) 
                errores.push('- Plazo debe ser mayor a 0');
            if (!datosFinancieros.ingresosMensuales || datosFinancieros.ingresosMensuales <= 0) 
                errores.push('- Ingresos Mensuales deben ser mayores a 0');
            
            if (errores.length > 0) {
                alert('‚ùå Se encontraron los siguientes errores:\n\n' + errores.join('\n'));
                return false;
            } else {
                alert('‚úÖ Todos los datos son v√°lidos');
                return true;
            }
        }

        // Calcular m√©tricas
        function calcularMetricas() {
            if (Object.keys(datosFinancieros).length === 0) {
                alert('‚ö†Ô∏è Primero debe ingresar y guardar los datos en la pesta√±a "Datos Base"');
                return;
            }

            const d = datosFinancieros;
            
            // M√©tricas actuales
            const deudaIngresos = d.deudaTotal / (d.ingresosMensuales * 12);
            const gastoFinancieroVentas = (d.gastosFinancieros * 12 / d.ventasAnuales) * 100;
            const ratioCobertura = (d.utilidadOperacional / d.gastosFinancieros);
            const margenOperativo = (d.utilidadOperacional * 12 / d.ventasAnuales) * 100;
            const servicioDeuda = (d.gastosFinancieros / d.ingresosMensuales) * 100;

            // M√©tricas proyectadas
            const nuevoCapital = d.deudaTotal * (1 - d.quitaCapital / 100);
            const nuevoGastoFinanciero = nuevoCapital * (d.nuevaTasa / 100) / 12;
            
            const deudaIngresosProy = nuevoCapital / (d.ingresosMensuales * 12);
            const gastoFinancieroVentasProy = (nuevoGastoFinanciero * 12 / d.ventasAnuales) * 100;
            const diasPagoProy = d.diasPago * 0.85;
            const ratioCoberturaProy = (d.utilidadOperacional / nuevoGastoFinanciero);
            const margenOperativoProy = ((d.utilidadOperacional + d.gastosFinancieros - nuevoGastoFinanciero) * 12 / d.ventasAnuales) * 100;
            const servicioDeudaProy = (nuevoGastoFinanciero / d.ingresosMensuales) * 100;

            const metricas = [
                {
                    nombre: 'Deuda / Ingresos Anuales',
                    actual: deudaIngresos.toFixed(2),
                    proyectado: deudaIngresosProy.toFixed(2),
                    meta: 3,
                    mejoraEsMenor: true
                },
                {
                    nombre: 'Servicio de Deuda (%)',
                    actual: servicioDeuda.toFixed(2),
                    proyectado: servicioDeudaProy.toFixed(2),
                    meta: 30,
                    mejoraEsMenor: true
                },
                {
                    nombre: 'Gasto Financiero / Ventas (%)',
                    actual: gastoFinancieroVentas.toFixed(2),
                    proyectado: gastoFinancieroVentasProy.toFixed(2),
                    meta: 5,
                    mejoraEsMenor: true
                },
                {
                    nombre: 'D√≠as de Pago',
                    actual: d.diasPago,
                    proyectado: diasPagoProy.toFixed(0),
                    meta: 60,
                    mejoraEsMenor: true
                },
                {
                    nombre: 'Ratio de Cobertura',
                    actual: ratioCobertura.toFixed(2),
                    proyectado: ratioCoberturaProy.toFixed(2),
                    meta: 1.5,
                    mejoraEsMenor: false
                },
                {
                    nombre: 'Margen Operativo (%)',
                    actual: margenOperativo.toFixed(2),
                    proyectado: margenOperativoProy.toFixed(2),
                    meta: 15,
                    mejoraEsMenor: false
                }
            ];

            let html = '<div class="metrics-grid">';
            
            metricas.forEach(m => {
                const cumple = m.mejoraEsMenor 
                    ? parseFloat(m.proyectado) <= m.meta 
                    : parseFloat(m.proyectado) >= m.meta;
                
                const badgeClass = cumple ? 'status-success' : 'status-warning';
                const badgeText = cumple ? '‚úì Cumple' : '‚ö† No Cumple';
                
                html += `
                    <div class="metric-card">
                        <div class="metric-label">${m.nombre}</div>
                        <div class="metric-comparison">
                            <div class="metric-before">
                                <small>Actual</small>
                                <div style="font-size: 1.5em; font-weight: bold; color: #ff4d4f;">${m.actual}</div>
                            </div>
                            <div class="metric-arrow">‚Üí</div>
                            <div class="metric-after">
                                <small>Proyectado</small>
                                <div style="font-size: 1.5em; font-weight: bold; color: #52c41a;">${m.proyectado}</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <span class="status-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <div style="margin-top: 5px; color: #999; font-size: 0.85em;">Meta: ${m.meta}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('metricasContent').innerHTML = html;
            showSection('metricas');
            alert('‚úÖ M√©tricas calculadas exitosamente');
        }

        // Comparar escenarios
        function compararEscenarios() {
            if (Object.keys(datosFinancieros).length === 0) {
                alert('‚ö†Ô∏è Primero debe ingresar y guardar los datos');
                return;
            }

            const d = datosFinancieros;
            const tasaMensual = d.tasaInteres / 100 / 12;
            
            // Funci√≥n PMT
            function pmt(tasa, nper, va) {
                if (tasa === 0) return -va / nper;
                return tasa * va / (1 - Math.pow(1 + tasa, -nper));
            }

            // Situaci√≥n actual
            const cuotaActual = pmt(tasaMensual, d.plazoActual, -d.deudaTotal);
            const totalActual = cuotaActual * d.plazoActual;

            // Escenario 1: Reducci√≥n de tasa
            const tasa1 = (d.tasaInteres - 2) / 100 / 12;
            const cuota1 = pmt(tasa1, d.plazoActual, -d.deudaTotal);
            const total1 = cuota1 * d.plazoActual;
            const ahorro1 = totalActual - total1;

            // Escenario 2: Ampliaci√≥n de plazo
            const plazo2 = d.plazoActual + 24;
            const cuota2 = pmt(tasaMensual, plazo2, -d.deudaTotal);
            const total2 = cuota2 * plazo2;
            const ahorro2 = totalActual - total2;

            // Escenario 3: Quita + nueva tasa
            const deuda3 = d.deudaTotal * (1 - d.quitaCapital / 100);
            const tasa3 = d.nuevaTasa / 100 / 12;
            const cuota3 = pmt(tasa3, d.plazoActual, -deuda3);
            const total3 = cuota3 * d.plazoActual;
            const ahorro3 = totalActual - total3;

            const escenarios = [
                {
                    nombre: 'Situaci√≥n Actual',
                    deuda: d.deudaTotal,
                    tasa: d.tasaInteres,
                    plazo: d.plazoActual,
                    cuota: cuotaActual,
                    total: totalActual,
                    ahorro: 0
                },
                {
                    nombre: 'Escenario 1: Reducci√≥n de Tasa',
                    deuda: d.deudaTotal,
                    tasa: d.tasaInteres - 2,
                    plazo: d.plazoActual,
                    cuota: cuota1,
                    total: total1,
                    ahorro: ahorro1
                },
                {
                    nombre: 'Escenario 2: Ampliaci√≥n de Plazo',
                    deuda: d.deudaTotal,
                    tasa: d.tasaInteres,
                    plazo: plazo2,
                    cuota: cuota2,
                    total: total2,
                    ahorro: ahorro2
                },
                {
                    nombre: 'Escenario 3: Quita + Nueva Tasa',
                    deuda: deuda3,
                    tasa: d.nuevaTasa,
                    plazo: d.plazoActual,
                    cuota: cuota3,
                    total: total3,
                    ahorro: ahorro3
                }
            ];

            const mejorAhorro = Math.max(ahorro1, ahorro2, ahorro3);

            let html = '<div class="scenario-comparison">';
            
            escenarios.forEach(esc => {
                const esMejor = esc.ahorro === mejorAhorro && esc.ahorro > 0;
                const claseCard = esMejor ? 'scenario-card best' : 'scenario-card';
                
                html += `
                    <div class="${claseCard}">
                        <h4>${esc.nombre} ${esMejor ? '‚≠ê RECOMENDADO' : ''}</h4>
                        <div class="scenario-item">
                            <span>Deuda:</span>
                            <strong>${esc.deuda.toLocaleString('es-CL', {minimumFractionDigits: 2})}</strong>
                        </div>
                        <div class="scenario-item">
                            <span>Tasa:</span>
                            <strong>${esc.tasa.toFixed(2)}%</strong>
                        </div>
                        <div class="scenario-item">
                            <span>Plazo:</span>
                            <strong>${esc.plazo} meses</strong>
                        </div>
                        <div class="scenario-item">
                            <span>Cuota Mensual:</span>
                            <strong>${esc.cuota.toLocaleString('es-CL', {minimumFractionDigits: 2})}</strong>
                        </div>
                        <div class="scenario-item">
                            <span>Total a Pagar:</span>
                            <strong>${esc.total.toLocaleString('es-CL', {minimumFractionDigits: 2})}</strong>
                        </div>
                        ${esc.ahorro > 0 ? `
                        <div class="scenario-item" style="border-top: 2px solid #52c41a; margin-top: 10px; padding-top: 10px;">
                            <span style="color: #52c41a; font-weight: bold;">Ahorro Total:</span>
                            <strong style="color: #52c41a;">${esc.ahorro.toLocaleString('es-CL', {minimumFractionDigits: 2})}</strong>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';

            // Calcular ROI
            const ahorroAnual = (cuotaActual - cuota3) * 12;
            const costoRestructuracion = d.deudaTotal * 0.02;
            const roi = (ahorroAnual / costoRestructuracion) * 100;
            const mesesRecuperacion = (costoRestructuracion / ahorroAnual) * 12;

            html += `
                <div class="card" style="margin-top: 30px;">
                    <h3>üí° An√°lisis de ROI</h3>
                    <div class="dashboard-grid">
                        <div class="info-box">
                            <h4>Ahorro Anual Estimado</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #52c41a;">
                                ${ahorroAnual.toLocaleString('es-CL', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                        <div class="info-box">
                            <h4>Costo de Reestructuraci√≥n</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #ff4d4f;">
                                ${costoRestructuracion.toLocaleString('es-CL', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                        <div class="info-box">
                            <h4>ROI</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #1890ff;">
                                ${roi.toFixed(2)}%
                            </div>
                        </div>
                        <div class="info-box">
                            <h4>Per√≠odo de Recuperaci√≥n</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #722ed1;">
                                ${mesesRecuperacion.toFixed(1)} meses
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('escenariosContent').innerHTML = html;
            showSection('escenarios');
            alert('‚úÖ Escenarios comparados exitosamente');
        }

        // Registrar pago
        function registrarPago() {
            const fecha = document.getElementById('fechaPago').value;
            const concepto = document.getElementById('conceptoPago').value;
            const monto = parseFloat(document.getElementById('montoPago').value);
            const observaciones = document.getElementById('observacionesPago').value;

            if (!fecha || !concepto || !monto || monto <= 0) {
                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios');
                return;
            }

            const saldoAnterior = pagosRegistrados.length > 0 
                ? pagosRegistrados[pagosRegistrados.length - 1].saldo 
                : datosFinancieros.deudaTotal || 0;

            const saldoNuevo = saldoAnterior - monto;

            const pago = {
                fecha: fecha,
                concepto: concepto,
                monto: monto,
                saldo: saldoNuevo,
                observaciones: observaciones
            };

            pagosRegistrados.push(pago);
            actualizarTablaPagos();

            // Limpiar formulario
            document.getElementById('conceptoPago').value = '';
            document.getElementById('montoPago').value = '';
            document.getElementById('observacionesPago').value = '';

            alert(`‚úÖ Pago registrado exitosamente\n\nSaldo pendiente: ${saldoNuevo.toLocaleString('es-CL', {minimumFractionDigits: 2})}`);
        }

        // Actualizar tabla de pagos
        function actualizarTablaPagos() {
            const tbody = document.getElementById('bodyPagos');
            
            if (pagosRegistrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No hay pagos registrados</td></tr>';
                return;
            }

            let html = '';
            pagosRegistrados.forEach(pago => {
                html += `
                    <tr>
                        <td>${new Date(pago.fecha).toLocaleDateString('es-CL')}</td>
                        <td>${pago.concepto}</td>
                        <td>${pago.monto.toLocaleString('es-CL', {minimumFractionDigits: 2})}</td>
                        <td>${pago.saldo.toLocaleString('es-CL', {minimumFractionDigits: 2})}</td>
                        <td>${pago.observaciones || '-'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Actualizar dashboard
        function actualizarDashboard() {
            if (Object.keys(datosFinancieros).length === 0) return;

            const d = datosFinancieros;
            const html = `
                <div class="card">
                    <h3>üìä Resumen Financiero</h3>
                    <div class="dashboard-grid">
                        <div class="info-box">
                            <h4>Deuda Total</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #ff4d4f;">
                                ${d.deudaTotal.toLocaleString('es-CL', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                        <div class="info-box">
                            <h4>Tasa de Inter√©s</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #1890ff;">
                                ${d.tasaInteres.toFixed(2)}%
                            </div>
                        </div>
                        <div class="info-box">
                            <h4>Plazo Actual</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #722ed1;">
                                ${d.plazoActual} meses
                            </div>
                        </div>
                        <div class="info-box">
                            <h4>EBITDA Anual</h4>
                            <div style="font-size: 2em; font-weight: bold; color: #52c41a;">
                                ${d.ebitdaAnual.toLocaleString('es-CL', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success">
                    ‚úÖ Datos cargados correctamente. Ya puede calcular m√©tricas y comparar escenarios.
                </div>
            `;

            document.getElementById('dashboardMetrics').innerHTML = html;
        }

        // Generar reporte
        function generarReporte() {
            if (Object.keys(datosFinancieros).length === 0) {
                alert('‚ö†Ô∏è Primero debe ingresar y guardar los datos');
                return;
            }

            const d = datosFinancieros;
            const fechaHoy = new Date().toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Calcular m√©tricas para el reporte
            const deudaIngresos = (d.deudaTotal / (d.ingresosMensuales * 12)).toFixed(2);
            const gastoFinancieroVentas = ((d.gastosFinancieros * 12 / d.ventasAnuales) * 100).toFixed(2);
            const servicioDeuda = ((d.gastosFinancieros / d.ingresosMensuales) * 100).toFixed(2);

            const nuevoCapital = d.deudaTotal * (1 - d.quitaCapital / 100);
            const nuevoGastoFinanciero = nuevoCapital * (d.nuevaTasa / 100) / 12;
            const deudaIngresosProy = (nuevoCapital / (d.ingresosMensuales * 12)).toFixed(2);
            const servicioDeudaProy = ((nuevoGastoFinanciero / d.ingresosMensuales) * 100).toFixed(2);

            let html = `
                <div id="reportContent">
                    <div class="report-header">
                        <h1>üìä REPORTE DE REESTRUCTURACI√ìN DE DEUDA</h1>
                        <p style="color: #666; margin-top: 10px;">Fecha: ${fechaHoy}</p>
                    </div>

                    <div class="report-section">
                        <h3>üéØ PROBLEMA</h3>
                        <p>Estructura de deuda y gasto financiero elevada que restringe la inversi√≥n operativa y el crecimiento.</p>
                    </div>

                    <div class="report-section">
                        <h3>üí° PROPUESTA</h3>
                        <p>Reestructurar deuda y optimizar gastos mediante renegociaci√≥n de plazos/tasas; plan de pagos; recorte de costos no cr√≠ticos.</p>
                    </div>

                    <div class="report-section">
                        <h3>üìà IMPACTO ESPERADO</h3>
                        <p>Alto, por mejora de liquidez y capacidad de inversi√≥n.</p>
                    </div>

                    <div class="report-section">
                        <h3>üìä M√âTRICAS FINANCIERAS</h3>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Indicador</th>
                                    <th>Valor Actual</th>
                                    <th>Valor Proyectado</th>
                                    <th>Mejora</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Deuda / Ingresos</td>
                                    <td>${deudaIngresos}</td>
                                    <td>${deudaIngresosProy}</td>
                                    <td style="color: #52c41a; font-weight: bold;">‚Üì ${((1 - deudaIngresosProy/deudaIngresos) * 100).toFixed(1)}%</td>
                                </tr>
                                <tr>
                                    <td>Servicio de Deuda (%)</td>
                                    <td>${servicioDeuda}%</td>
                                    <td>${servicioDeudaProy}%</td>
                                    <td style="color: #52c41a; font-weight: bold;">‚Üì ${((1 - servicioDeudaProy/servicioDeuda) * 100).toFixed(1)}%</td>
                                </tr>
                                <tr>
                                    <td>Gasto Financiero / Ventas</td>
                                    <td>${gastoFinancieroVentas}%</td>
                                    <td>${((nuevoGastoFinanciero * 12 / d.ventasAnuales) * 100).toFixed(2)}%</td>
                                    <td style="color: #52c41a; font-weight: bold;">‚Üì Mejora</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>üí∞ DATOS FINANCIEROS</h3>
                        <table style="width: 100%; margin-top: 15px;">
                            <tbody>
                                <tr>
                                    <td><strong>Deuda Total Actual:</strong></td>
                                    <td>${d.deudaTotal.toLocaleString('es-CL', {minimumFractionDigits: 2})}</td>
                                </tr>
                                <tr>
                                    <td><strong>Tasa de Inter√©s:</strong></td>
                                    <td>${d.tasaInteres}%</td>
                                </tr>
                                <tr>
                                    <td><strong>Plazo Actual:</strong></td>
                                    <td>${d.plazoActual} meses</td>
                                </tr>
                                <tr>
                                    <td><strong>EBITDA Anual:</strong></td>
                                    <td>${d.ebitdaAnual.toLocaleString('es-CL', {minimumFractionDigits: 2})}</td>
                                </tr>
                                <tr style="border-top: 2px solid #0070c9;">
                                    <td><strong>Nueva Tasa Propuesta:</strong></td>
                                    <td style="color: #52c41a; font-weight: bold;">${d.nuevaTasa}%</td>
                                </tr>
                                <tr>
                                    <td><strong>Quita de Capital:</strong></td>
                                    <td style="color: #52c41a; font-weight: bold;">${d.quitaCapital}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>üéØ OBJETIVOS</h3>
                        <p>Disminuir servicio de la deuda y mejorar flujo de caja.</p>
                    </div>

                    <div class="report-section">
                        <h3>‚úÖ RESULTADOS ESPERADOS</h3>
                        <p>Mayor solvencia y margen operativo.</p>
                    </div>

                    <div class="report-section">
                        <h3>üìÖ PLAZO DE EJECUCI√ìN</h3>
                        <p><strong>01-06-2026 a 14-12-2026</strong> (Largo Plazo)</p>
                    </div>

                    <div class="report-section">
                        <h3>üîç VIABILIDAD</h3>
                        <p>Alta posibilidad de negociar con acreedores/entidades.</p>
                    </div>

                    ${pagosRegistrados.length > 0 ? `
                    <div class="report-section">
                        <h3>üí∏ HISTORIAL DE PAGOS</h3>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Monto</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pagosRegistrados.map(p => `
                                    <tr>
                                        <td>${new Date(p.fecha).toLocaleDateString('es-CL')}</td>
                                        <td>${p.concepto}</td>
                                        <td>${p.monto.toLocaleString('es-CL', {minimumFractionDigits: 2})}</td>
                                        <td>${p.saldo.toLocaleString('es-CL', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #0070c9; text-align: center; color: #999;">
                        <p>Reporte generado autom√°ticamente - Sistema de Reestructuraci√≥n de Deuda</p>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            showSection('reporte');
            alert('‚úÖ Reporte generado exitosamente');
        }

        // Exportar a PDF
        function exportarPDF() {
            const reportContent = document.getElementById('reportContent');
            
            if (!reportContent || reportContent.innerHTML.trim() === '') {
                alert('‚ö†Ô∏è Primero debe generar el reporte');
                return;
            }

            // Usar html2canvas y jsPDF
            html2canvas(reportContent, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const fecha = new Date().toISOString().split('T')[0];
                pdf.save(`Reporte_Reestructuracion_${fecha}.pdf`);
                
                alert('‚úÖ PDF descargado exitosamente');
            }).catch(error => {
                console.error('Error al generar PDF:', error);
                alert('‚ùå Error al generar PDF. Intente usar el bot√≥n Imprimir como alternativa.');
            });
        }

        // Cargar datos de ejemplo al inicio
        window.addEventListener('load', function() {
            // Puedes descomentar esto para cargar datos de ejemplo
            /*
            document.getElementById('deudaTotal').value = 1000000;
            document.getElementById('tasaInteres').value = 12.5;
            document.getElementById('plazoActual').value = 36;
            document.getElementById('ingresosMensuales').value = 150000;
            document.getElementById('ventasAnuales').value = 2000000;
            document.getElementById('utilidadOperacional').value = 30000;
            document.getElementById('gastosFinancieros').value = 12000;
            document.getElementById('diasPago').value = 45;
            document.getElementById('nuevaTasa').value = 8.5;
            document.getElementById('nuevoPlazo').value = 48;
            document.getElementById('quitaCapital').value = 15;
            document.getElementById('reduccionGastos').value = 5000;
            */
        });
    </script>
</body>
</html>